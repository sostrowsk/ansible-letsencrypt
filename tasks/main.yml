---
  - apt: update_cache=yes cache_valid_time=3600

  - name: Install depends
    apt:
      pkg: ['virtualenv', 'gcc', 'dialog', 'libaugeas0', 'libssl-dev', 'libffi-dev', 'ca-certificates', 'git']
      state: present

  - name: Install virtualenv (Debian)
    apt:
      pkg: ['python', 'python-dev', 'python-virtualenv', 'python-pip']
      state: present
    when: ansible_distribution == 'Debian' and ansible_lsb.codename !=  "wheezy"

  - name: Install virtualenv (Debian)
    apt:
      pkg: ['python3', 'python3-dev', 'python3-virtualenv', 'python3-pip', 'python3-setuptools']
      state: present
    when: ansible_distribution == "Debian" and ansible_distribution_release == "bullseye"

  - name: More python depends
    pip: virtualenv="{{ letsencrypt_venv }}" virtualenv_site_packages=no name=letsencrypt

  - name: Ensure webroot exists
    file: path="{{ letsencrypt_webroot_path }}" state=directory recurse=yes mode="a+rw"

  - name: Attempt to get the certificate using the webroot authenticator
    command: "{{ letsencrypt_command }} -a webroot --webroot-path {{ letsencrypt_webroot_path }} certonly"
    args:
      creates: "/etc/letsencrypt/live/{{ letsencrypt_cert_domains[0] }}"
    when: letsencrypt_authenticator == "webroot"
    ignore_errors: True

  - name: Attempt to get the certificate using the standalone authenticator (in case eg the webserver isn't running yet)
    command: "{{ letsencrypt_command }} -a standalone auth"
    args:
      creates: "/etc/letsencrypt/live/{{ letsencrypt_cert_domains[0] }}"

  - name: Fix the renewal file
    ini_file: section=renewalparams option={{ item.key }} value={{ item.value }} dest="/etc/letsencrypt/renewal/{{ letsencrypt_cert_domains[0] }}.conf"
    with_dict:
      os_packages_only: False
      verb: certonly
      noninteractive_mode: False
      uir: False
      hsts: False

  - name: Fix the webroot map in the renewal file
    ini_file: section="[webroot_map]" option={{ item }} value={{ letsencrypt_webroot_path }} dest="/etc/letsencrypt/renewal/{{ letsencrypt_cert_domains[0] }}.conf"
    with_items: "{{ letsencrypt_cert_domains }}"

  - name: Install renewal cron
    cron: name="Let's Encrypt Renewal" day="{{ letsencrypt_renewal_frequency.day }}" hour="{{ letsencrypt_renewal_frequency.hour }}" minute="{{ letsencrypt_renewal_frequency.minute }}" job="{{ letsencrypt_venv }}/bin/letsencrypt renew > /dev/null"
